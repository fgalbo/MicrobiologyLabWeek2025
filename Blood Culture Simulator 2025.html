<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microbiology Lab Week Game 2025</title>
    <!-- Favicon Link -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3E%3Ccircle%20cx='32'%20cy='32'%20r='30'%20fill='%23E0F8FF'%20stroke='%23A0D8E8'%20stroke-width='2'/%3E%3Ccircle%20cx='32'%20cy='32'%20r='26'%20fill='%23FFF8DC'%20opacity='0.8'/%3E%3Ccircle%20cx='25'%20cy='30'%20r='5'%20fill='%23DC3545'/%3E%3Ccircle%20cx='42'%20cy='40'%20r='4'%20fill='%230056B3'/%3E%3C/svg%3E" type="image/svg+xml" sizes="any">
    <!-- End Favicon Link -->
    <style>
        /* --- Basic Reset & Body --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: sans-serif; display: flex; justify-content: center; align-items: center;
            min-height: 100vh; background-color: #f0f8ff; color: #333;
            padding: 20px; overflow: hidden;
             /* Prevent pull-to-refresh and other touch actions on body */
             overscroll-behavior-y: contain;
        }

        /* --- Game Container --- */
        #game-container {
            background-color: #ffffff; padding: 0; border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); text-align: center;
            width: 90%; max-width: 850px;
            position: relative; overflow: hidden; min-height: 600px;
            height: 90vh; max-height: 750px;
            display: flex; flex-direction: column;
        }

        /* --- Screen Styling --- */
        .screen {
            display: none; flex-direction: column; align-items: center;
            gap: 15px; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            padding: 30px; overflow-y: auto; background-color: #ffffff;
            justify-content: center;
        }
        .screen.active { display: flex; z-index: 1; }
        h1 { font-size: 1.8em; color: #0056b3; margin-bottom: 10px; }
        h2 { font-size: 1.5em; color: #0056b3; margin-bottom: 15px; margin-top: 10px;}
        p.story-text { font-size: 1.2em; font-style: italic; color: #444; margin: 10px 0;}


        /* --- Input & Buttons --- */
        input[type="text"] { padding: 10px; border: 1px solid #ccc; border-radius: 5px; width: 80%; max-width: 300px; font-size: 1em; }
        button { padding: 12px 25px; font-size: 1em; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.3s ease; margin-top: 5px; margin-bottom: 5px; }
        button:hover { background-color: #0056b3; }
        button.secondary { background-color: #6c757d; }
        button.secondary:hover { background-color: #5a6268; }
        #clearHallOfFameButton { background-color: #dc3545; margin-top: 15px; }
        #clearHallOfFameButton:hover { background-color: #c82333; }

        /* --- Start Screen --- */
        #start-screen { background-color: #e6f2ff; justify-content: center; }
        #lab-week-banner { width: 90%; max-width: 500px; margin: 15px auto 25px auto; display: block; }
        #lab-week-banner svg { display: block; width: 100%; height: auto; }
        .banner-text { font-family: 'Arial Black', Gadget, sans-serif; font-size: 40px; fill: #0056b3; stroke: #ffffff; stroke-width: 1px; text-anchor: middle; }
        .banner-subtext { font-family: sans-serif; font-size: 18px; fill: #007bff; text-anchor: middle; }
        @keyframes wiggle { 0%, 100% { transform: rotate(-2deg); } 50% { transform: rotate(2deg); } } @keyframes pulse { 0%, 100% { opacity: 0.7; } 50% { opacity: 1; } } @keyframes slowRotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        #banner-bacteria1 { animation: wiggle 4s ease-in-out infinite alternate; transform-origin: center; } #banner-bacteria2 { animation: wiggle 3.5s ease-in-out infinite alternate-reverse; transform-origin: center; } #banner-dna { animation: pulse 3s ease-in-out infinite; } #banner-atom { animation: slowRotate 20s linear infinite; transform-origin: center; }
        #start-screen-decorations { position: absolute; top: 10px; left: 10px; right: 10px; bottom: 10px; pointer-events: none; overflow: hidden; }
        #start-screen-decorations svg { position: absolute; opacity: 0.15; }
        #deco-dna { top: 15px; left: 15px; transform: rotate(-15deg); width: 60px; height: 60px; } #deco-bacteria { bottom: 15px; right: 15px; width: 50px; height: 50px; transform: rotate(10deg); } #deco-petri { bottom: 20px; left: 20px; width: 45px; height: 45px; transform: rotate(5deg); } #deco-microscope { top: 10px; right: 10px; width: 70px; height: 70px; opacity: 0.1; transform: rotate(5deg); } #deco-tube { bottom: 70px; left: 10px; width: 40px; height: 40px; transform: rotate(-10deg); opacity: 0.2;} #deco-flask { top: 60%; left: 5%; width: 50px; height: 50px; transform: rotate(15deg); opacity: 0.1;} #deco-pipette { top: 55%; right: 8%; width: 60px; height: 60px; transform: rotate(-5deg) scaleX(-1); opacity: 0.12;}

        /* --- Simple Intro Screens --- */
         #shift-start-screen, #alert-screen, #fix-instruction-screen, #fix-confirmation-screen {
             background-color: #f8f9fa;
         }

        /* --- Prepare Smear Screen --- */
        #prepare-smear-screen { justify-content: flex-start; align-items: center;}
        #prep-container { display: flex; justify-content: space-around; align-items: flex-end; width: 90%; gap: 30px; margin-top: 20px; margin-bottom: 30px; flex-wrap: wrap; min-height: 100px; }
        .prep-item { padding: 5px; border: 1px solid transparent; border-radius: 8px; background-color: transparent; cursor: grab; text-align: center; transition: opacity 0.3s ease, transform 0.2s ease, background-color 0.2s ease, border-color 0.2s ease; user-select: none; display: flex; flex-direction: column; align-items: center; min-width: 80px; touch-action: none; /* Prevent scrolling on touch drag */ }
         #prep-wipe-container { background-color: #e9ecef; border-color: #ccc; padding: 10px;}
         .prep-item svg { width: 60px; height: 80px; display: block; margin-bottom: 5px; }
         #prep-needle-svg { height: 70px; width: 20px; }
         #prep-bottle-svg { width: 70px; height: 90px; }
         .prep-item .prep-label { font-size: 0.8em; color: #333; font-weight: bold; }
        .prep-item:active { cursor: grabbing; transform: scale(1.05); }
        .prep-item.used { opacity: 0.4; cursor: default; pointer-events: none; background-color: #e9ecef !important; border-color: #ddd !important; }
         #prep-wipe-container.used { background-color: #e9ecef; }
        .prep-item.drag-over-target, #smear-graphic-target.drag-over-target { border: 2px dashed #007bff !important; background-color: #e7f3ff !important; }
        #smear-graphic-target { width: 200px; height: 80px; border: 3px dashed #6c757d; border-radius: 10px; display: flex; justify-content: center; align-items: center; background-color: #e9ecef; margin-top: 20px; transition: background-color 0.3s ease, border-color 0.3s ease, visibility 0s linear 0.5s, opacity 0.5s ease-in-out; position: relative; overflow: hidden; padding: 5px; visibility: hidden; opacity: 0; }
         #smear-graphic-target.visible { visibility: visible; opacity: 1; transition-delay: 0s; }
         #smear-graphic-target #smear-slide-visual { width: 180px; height: 65px; background-color: rgba(212, 241, 249, 0.9); border: 1px solid #a0d8e8; border-radius: 5px; position: relative; box-shadow: inset 0 0 5px rgba(255,255,255,0.5); }
         #smear-graphic-target #smear-slide-visual .smear-spot { position: absolute; left: 30px; top: 20px; width: 40px; height: 25px; background-color: #f8d7da; border-radius: 30%; opacity: 0; transition: opacity 0.5s ease; }
          #smear-graphic-target #smear-slide-visual .smear-spot.visible { opacity: 0.8; }
        #prep-feedback { margin-top: 20px; font-weight: bold; min-height: 1.5em;}
        #prep-feedback.error { color: #dc3545; }
        #prep-feedback.success { color: #28a745; }

        /* --- Fixing Animation --- */
        #fix-confirmation-screen #fixed-slide-graphic { width: 180px; height: 65px; background-color: #d4f1f9; border: 1px solid #a0d8e8; border-radius: 5px; position: relative; box-shadow: inset 0 0 5px rgba(255,255,255,0.5); overflow: hidden; }
        #fix-confirmation-screen #fixed-slide-graphic::after { content: ''; position: absolute; top: -100%; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, rgba(173, 216, 230, 0.7), rgba(173, 216, 230, 0)); animation: methanol-spray 0.8s ease-out forwards; opacity: 0; }
        @keyframes methanol-spray { 0% { transform: translateY(0); opacity: 0; } 50% { opacity: 1; } 100% { transform: translateY(100%); opacity: 0; } }

        /* --- Phase 1: Gram Stain --- */
        #game-phase-1.active { background-image: linear-gradient(rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.9)), url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><defs><pattern id="benchPattern" width="20" height="20" patternUnits="userSpaceOnUse"><path d="M0 0h20v20H0z" fill="%23f0f0f0"/><path d="M0 0h1v20H0zm10 0h1v20h-1z M0 0h20v1H0zm0 10h20v1H0z" fill="%23dcdcdc"/></pattern></defs><rect width="100%" height="100%" fill="url(%23benchPattern)"/></svg>'); background-size: auto; background-position: center center; background-repeat: repeat; z-index: 2; justify-content: flex-start; }
        #phase-1-content { background-color: rgba(255, 255, 255, 0.7); padding: 20px; border-radius: 8px; width: 95%; display: flex; justify-content: space-around; align-items: flex-start; gap: 20px; flex-wrap: wrap; margin-top: 10px; }
        #reagents { display: flex; flex-direction: row; flex-wrap: wrap; justify-content: center; gap: 15px; padding: 15px; border: 1px dashed #aaa; border-radius: 5px; background-color: rgba(248, 249, 250, 0.95); min-height: auto; align-items: flex-end; width: 100%; max-width: 420px; }
        /* Reagent Bottle Styling */
        .reagent { display: flex; flex-direction: column; align-items: center; cursor: grab; user-select: none; width: 75px; transition: opacity 0.3s ease; margin-bottom: 5px; touch-action: none; /* Prevent scrolling on touch drag */ }
        .reagent:active { cursor: grabbing; transform: scale(1.05); } .reagent.used { opacity: 0.4; cursor: default; pointer-events: none;} .bottle-neck { width: 22px; height: 13px; background-color: #a9a9a9; border: 1px solid #555; border-bottom: none; border-radius: 5px 5px 0 0; } .bottle-body { width: 45px; height: 65px; border: 1px solid #666; border-top: none; border-radius: 0 0 8px 8px; position: relative; background-color: #e0e0e0; } .reagent-label { margin-top: 4px; font-size: 0.7em; text-align: center; color: #333; font-weight: bold; max-width: 100%; overflow-wrap: break-word; } #reagent-cv .bottle-body { background-color: #8a2be2; } #reagent-iodine .bottle-body { background-color: #a0522d; } #reagent-decolorizer .bottle-body { background-color: rgba(240, 248, 255, 0.8); border: 1px solid #aaa; } #reagent-safranin .bottle-body { background-color: #ff69b4; }
        /* Slide Area Styling */
        #slide-container { display: flex; flex-direction: column; align-items: center; gap: 10px; background-color: rgba(240, 248, 255, 0.95); padding: 15px; border-radius: 8px; width: auto; min-width: 260px; } #slide-dropzone { width: 250px; height: 120px; border: 3px dashed #007bff; border-radius: 10px; display: flex; justify-content: center; align-items: center; background-color: transparent; transition: background-color 0.3s ease, border-color 0.3s ease; position: relative; overflow: hidden; padding: 10px; } #slide-dropzone.drag-over { background-color: rgba(204, 229, 255, 0.7); border-color: #0056b3; } #slide-graphic { width: 180px; height: 65px; background-color: rgba(212, 241, 249, 0.9); border: 1px solid #a0d8e8; border-radius: 5px; position: relative; box-shadow: inset 0 0 5px rgba(255,255,255,0.5); } #frosted-end { position: absolute; right: 5px; top: 5px; bottom: 5px; width: 40px; background-color: rgba(255, 255, 255, 0.7); border-radius: 3px; pointer-events: none; } #stained-area { position: absolute; left: 30px; top: 20px; width: 40px; height: 25px; background-color: transparent; border-radius: 30%; opacity: 0.8; transition: background-color 0.5s ease; pointer-events: none; } #slide-dropzone p.drop-instruction { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: rgba(0, 0, 0, 0.5); font-style: italic; z-index: 1; pointer-events: none; display: block; transition: color 0.3s ease; } #slide-dropzone.drag-over p.drop-instruction { color: rgba(0, 86, 179, 0.8); } #slide-dropzone.has-content p.drop-instruction { display: none; } #stain-status { font-weight: bold; padding: 5px 10px; border-radius: 3px; width: 100%; margin-top: 5px; opacity: 0; transition: opacity 0.5s ease, background-color 0.5s ease; min-height: 1.5em; text-align: center; background-color: rgba(255,255,255,0.8); } #stain-status.success { background-color: #d4edda; color: #155724; opacity: 1; } #stain-status.error { background-color: #f8d7da; color: #721c24; opacity: 1; }

        /* --- Phase 2: Microscope Effect --- */
        #game-phase-2.active { background-color: #000000; color: #e0e0e0; z-index: 10; justify-content: center; }
        #game-phase-2.active h2, #game-phase-2.active p { color: #e0e0e0; position: relative; z-index: 12; }
        #microscope-image-container { width: 300px; height: 300px; border: 5px solid #d4af37; box-shadow: 0 0 30px 8px rgba(255, 255, 200, 0.7); background-color: #111; display: flex; justify-content: center; align-items: center; overflow: hidden; border-radius: 50%; margin-bottom: 20px; position: relative; z-index: 11; }
        #microscope-image { max-width: 100%; max-height: 100%; display: block; }
        #choices { display: flex; flex-direction: column; gap: 10px; width: 80%; max-width: 400px; position: relative; z-index: 12; }
        #choices button { background-color: #555; color: #fff; } #choices button:hover { background-color: #777; }

        /* --- Victory Screen Flair --- */
        #victory-screen { position: relative; background: linear-gradient(135deg, #e6fffa 0%, #ccffee 100%); justify-content: center; }
        #victory-decorations { position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; overflow: hidden; z-index: 0; }
        .flair-svg { position: absolute; opacity: 0.25; }
        #vic-dna { top: 10%; left: 5%; width: 70px; height: 70px; transform: rotate(-25deg); opacity: 0.2;} #vic-microscope { bottom: 8%; right: 5%; width: 80px; height: 80px; transform: rotate(15deg) scaleX(-1);} #vic-tube { top: 15%; right: 10%; width: 50px; height: 50px; transform: rotate(20deg);} #vic-virus { bottom: 12%; left: 8%; width: 60px; height: 60px; transform: rotate(-10deg); opacity: 0.2;}
        #victory-screen h2, #victory-screen p, #victory-screen button { position: relative; z-index: 2; }

        /* --- Failure Screen Flair --- */
        #failure-screen { justify-content: center; } #failure-screen h2 { color: #dc3545; font-size: 1.8em; } #failure-screen .flair-text { font-style: italic; color: #555; margin: 5px 0; } #incident-report-img { display: block; margin: 15px auto; max-width: 160px; height: auto; border: 2px solid #daa520; border-radius: 5px; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); } #failure-morphology-info { display: none; }

        /* --- Hall of Fame --- */
        #hall-of-fame-screen { justify-content: flex-start; } #hall-of-fame-list { list-style: none; padding: 0; margin-top: 15px; max-height: 250px; overflow-y: auto; border: 1px solid #eee; border-radius: 5px; background-color: #f8f9fa; width: 80%; max-width: 400px; } #hall-of-fame-list li { padding: 8px 15px; border-bottom: 1px solid #eee; text-align: left; } #hall-of-fame-list li:last-child { border-bottom: none; } #hall-of-fame-list li:nth-child(odd) { background-color: #e9ecef; }

        /* --- Victory/Failure Messages --- */
        #victory-message, #failure-message { font-size: 1.2em; font-weight: bold; margin-bottom: 10px; } #victory-message { color: #28a745; } #failure-message { color: #dc3545; margin-top: 10px;}

    </style>
</head>
<body>

    <div id="game-container">

        <!-- Start Screen -->
        <div id="start-screen" class="screen active">
             <div id="start-screen-decorations"> <svg id="deco-dna" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M30,10 C40,25 40,40 30,50 S20,75 30,90" stroke="#0056b3" stroke-width="5" fill="none"/><path d="M70,10 C60,25 60,40 70,50 S80,75 70,90" stroke="#0056b3" stroke-width="5" fill="none"/><line x1="30" y1="10" x2="70" y2="10" stroke="#6c757d" stroke-width="3"/><line x1="32" y1="20" x2="68" y2="20" stroke="#6c757d" stroke-width="3"/><line x1="35" y1="30" x2="65" y2="30" stroke="#6c757d" stroke-width="3"/><line x1="40" y1="40" x2="60" y2="40" stroke="#6c757d" stroke-width="3"/><line x1="40" y1="50" x2="60" y2="50" stroke="#6c757d" stroke-width="3"/><line x1="35" y1="60" x2="65" y2="60" stroke="#6c757d" stroke-width="3"/><line x1="32" y1="70" x2="68" y2="70" stroke="#6c757d" stroke-width="3"/><line x1="30" y1="80" x2="70" y2="80" stroke="#6c757d" stroke-width="3"/><line x1="30" y1="90" x2="70" y2="90" stroke="#6c757d" stroke-width="3"/></svg> <svg id="deco-bacteria" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="25" cy="30" r="8" fill="#007bff"/><ellipse cx="60" cy="40" rx="15" ry="8" fill="#007bff" transform="rotate(-20 60 40)"/><circle cx="40" cy="70" r="6" fill="#007bff"/><ellipse cx="75" cy="75" rx="12" ry="6" fill="#007bff" transform="rotate(30 75 75)"/></svg> <svg id="deco-petri" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="45" fill="#e0f8ff" stroke="#a0d8e8" stroke-width="3"/><circle cx="50" cy="50" r="40" fill="#ffebcc" opacity="0.7"/><circle cx="35" cy="40" r="5" fill="#dc3545" opacity="0.8"/><circle cx="60" cy="60" r="4" fill="#dc3545" opacity="0.8"/><circle cx="55" cy="35" r="3" fill="#dc3545" opacity="0.8"/></svg> <svg id="deco-microscope" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M40 90h20v5H40zM45 80h10v10H45z M30 75h40v5H30z M70 40a5 5 0 0 1-5 5h-5v20h10a5 5 0 0 1 5 5v5h-5v-5a10 10 0 0 0-10-10h-5V50h-5a10 10 0 0 0-10 10v5H20v-5a5 5 0 0 1 5-5h10V45h-5a5 5 0 0 1-5-5V20a5 5 0 0 1 5-5h5v-5h10v5h5a5 5 0 0 1 5 5z M50 25a15 15 0 1 1 0 30a15 15 0 0 1 0-30z" fill="#6c757d"/></svg> <svg id="deco-tube" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M30 10h40v70a20 20 0 0 1-40 0z" fill="#e0ffff" stroke="#add8e6" stroke-width="2"/><rect x="30" y="10" width="40" height="10" fill="#f08080" opacity="0.6"/></svg> <svg id="deco-flask" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M50 10h10v20H40V10z M40 30 L20 90 h60 L60 30 z" fill="#cceeff" stroke="#88aabb" stroke-width="2" /></svg> <svg id="deco-pipette" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M50 90 L60 70 h-20 z M45 70 V 20 h10 V 70 z M40 20 a 10 10 0 0 1 20 0 H 40 z" fill="#ddeeff" stroke="#aaccdd" stroke-width="1.5" /></svg> </div>
             <div id="lab-week-banner"> <svg viewBox="0 0 600 150" xmlns="http://www.w3.org/2000/svg"> <g id="banner-dna" transform="translate(30, 75) scale(0.6)"> <path d="M30,10 C40,25 40,40 30,50 S20,75 30,90 M70,10 C60,25 60,40 70,50 S80,75 70,90" stroke="#6c757d" stroke-width="8" fill="none" opacity="0.7"/> <path d="M30 10 L70 10 M32 20 L68 20 M35 30 L65 30 M40 40 L60 40 M40 50 L60 50 M35 60 L65 60 M32 70 L68 70 M30 80 L70 80 M30 90 L70 90" stroke="#a0d8e8" stroke-width="5" fill="none" opacity="0.7"/> </g> <g id="banner-bacteria1" transform="translate(500, 40) scale(0.5)"> <circle cx="25" cy="30" r="12" fill="#f08080"/> <ellipse cx="60" cy="40" rx="20" ry="10" fill="#ffcc80" transform="rotate(-20 60 40)"/> </g> <g id="banner-bacteria2" transform="translate(480, 110) scale(0.4)"> <circle cx="40" cy="70" r="10" fill="#90ee90"/> <ellipse cx="75" cy="75" rx="15" ry="8" fill="#add8e6" transform="rotate(30 75 75)"/> </g> <g id="banner-atom" transform="translate(70, 80) scale(0.4)"> <circle cx="50" cy="50" r="5" fill="#0056b3"/> <ellipse cx="50" cy="50" rx="40" ry="15" stroke="#007bff" stroke-width="3" fill="none"/> <ellipse cx="50" cy="50" rx="40" ry="15" stroke="#007bff" stroke-width="3" fill="none" transform="rotate(60 50 50)"/> <ellipse cx="50" cy="50" rx="40" ry="15" stroke="#007bff" stroke-width="3" fill="none" transform="rotate(120 50 50)"/> </g> <text x="300" y="70" class="banner-text">Happy Lab Week 2025</text> <text x="300" y="105" class="banner-subtext">from Micro/Molecular!</text> </svg> </div>
             <h1>Microbiology Lab Week Game!</h1>
             <p>Test your Gram Staining skills!</p>
             <label for="playerName">Enter your name:</label>
             <input type="text" id="playerName" placeholder="E.g., Alex">
             <button id="startButton">Start Game!</button>
             <button id="startViewHallOfFameButton" class="secondary">View Hall of Fame</button>
        </div>

        <!-- Intro Scene 1: Shift Start -->
        <div id="shift-start-screen" class="screen"> <p class="story-text">Your shift starts...</p> </div>

        <!-- Intro Scene 2: Alert -->
        <div id="alert-screen" class="screen"> <p class="story-text" style="font-size: 1.8em; font-weight: bold; color: red;">Bark Bark Bark!</p> <p class="story-text">Oh no! There's a positive blood culture!</p> <p class="story-text">No time for training, let's make that slide STAT!</p> </div>

        <!-- Intro Scene 3: Prepare Smear Mini-Game -->
        <div id="prepare-smear-screen" class="screen">
             <h2>Prepare the Smear</h2>
             <p>Drag items in order: Wipe -> Bottle, Needle -> Bottle, Bottle -> Slide</p>
             <div id="prep-container">
                 <div id="prep-wipe-container" class="prep-item" draggable="true"> <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"> <rect x="10" y="15" width="80" height="70" rx="5" ry="5" fill="#ffffff" stroke="#cccccc" stroke-width="2"/> <path d="M20 30 h60 M20 40 h60 M20 50 h60 M20 60 h60 M20 70 h60" stroke="#eeeeee" stroke-width="1"/> </svg> <span class="prep-label">Alcohol Wipe</span> </div>
                 <div id="prep-needle-container" class="prep-item" draggable="true"> <svg id="prep-needle-svg" viewBox="0 0 20 70" xmlns="http://www.w3.org/2000/svg"> <rect x="5" y="10" width="10" height="50" fill="#cccccc"/> <path d="M5 60 L10 70 L15 60 Z" fill="#aaaaaa" /> <rect x="2" y="0" width="16" height="10" rx="2" ry="2" fill="#888888"/> </svg> <span class="prep-label">Needle</span> </div>
                 <div id="prep-bottle-container" class="prep-item" draggable="true"> <svg id="prep-bottle-svg" viewBox="0 0 70 90" xmlns="http://www.w3.org/2000/svg"> <defs> <linearGradient id="bottleGrad" x1="0%" y1="0%" x2="100%" y2="0%"> <stop offset="0%" style="stop-color:#f5f5f5"/> <stop offset="50%" style="stop-color:#ffffff"/> <stop offset="100%" style="stop-color:#f5f5f5"/> </linearGradient> </defs> <rect x="5" y="15" width="60" height="70" rx="10" ry="10" fill="url(#bottleGrad)" stroke="#bbbbbb" stroke-width="1"/> <rect x="20" y="0" width="30" height="18" rx="2" ry="2" fill="#dc3545" stroke="#c82333" stroke-width="1"/> <rect x="10" y="60" width="50" height="25" fill="#f8d7da" opacity="0.5"/> <text x="35" y="50" font-family="sans-serif" font-size="10px" fill="#721c24" text-anchor="middle" font-weight="bold">BC+</text> </svg> <span class="prep-label">BC Bottle</span> </div>
             </div>
             <div id="smear-graphic-target"> <div id="smear-slide-visual"> <div class="smear-spot"></div> </div> </div>
             <div id="prep-feedback">Step 1: Drag Wipe to Bottle.</div>
        </div>

        <!-- Intro Scene 4: Fix Instruction -->
        <div id="fix-instruction-screen" class="screen"> <h2>Smear Ready!</h2> <p class="story-text">Okay, we made the perfect smear.</p> <p class="story-text">Now let's fix it!</p> <button id="fixSlideButton">Fix the Slide!</button> </div>

        <!-- Intro Scene 5: Fix Confirmation -->
        <div id="fix-confirmation-screen" class="screen"> <h2>Fixing...</h2> <div id="fixed-slide-graphic"> <div style="position: absolute; left: 30px; top: 20px; width: 40px; height: 25px; background-color: #f8d7da; border-radius: 30%; opacity: 0.6;"></div> </div> <p class="story-text">Okay, the slide is fixed.</p> <p class="story-text">Let's stain that slide STAT!</p> <button id="goToStainButton">Stain the Slide!</button> </div>

        <!-- Phase 1: Gram Stain -->
        <div id="game-phase-1" class="screen"> <h2>Phase 1: Gram Stain Procedure</h2> <div id="phase-1-content"> <div id="reagents"> <div class="reagent" id="reagent-cv" draggable="true" title="Crystal Violet..."> <div class="bottle-neck"></div> <div class="bottle-body"></div> <div class="reagent-label">Crystal Violet</div> </div> <div class="reagent" id="reagent-iodine" draggable="true" title="Gram's Iodine..."> <div class="bottle-neck"></div> <div class="bottle-body"></div> <div class="reagent-label">Iodine</div> </div> <div class="reagent" id="reagent-decolorizer" draggable="true" title="Decolorizer..."> <div class="bottle-neck"></div> <div class="bottle-body"></div> <div class="reagent-label">Decolorizer</div> </div> <div class="reagent" id="reagent-safranin" draggable="true" title="Safranin..."> <div class="bottle-neck"></div> <div class="bottle-body"></div> <div class="reagent-label">Safranin</div> </div> </div> <div id="slide-container"> <div id="slide-dropzone" aria-live="polite"> <p class="drop-instruction">Drop Reagent Here</p> <div id="slide-graphic"> <div id="frosted-end"></div> <div id="stained-area"></div> </div> </div> <div id="stain-status" aria-live="polite">Status</div> </div> </div> </div>

        <!-- Phase 2: Microscope Identification -->
        <div id="game-phase-2" class="screen"> <h2>Phase 2: Microscopic Identification</h2> <p>Identify the Gram stain reaction and morphology.</p> <div id="microscope-image-container"> <img id="microscope-image" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='48' fill='%23e0e0e0'/%3E%3Ctext x='50' y='55' font-size='10' text-anchor='middle' fill='%23333'%3EImage Loading...%3C/text%3E%3C/svg%3E" alt="Microscope View"> </div> <div id="choices"> </div> </div>

        <!-- Victory Screen -->
        <div id="victory-screen" class="screen"> <div id="victory-decorations"> <svg id="vic-dna" class="flair-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M30,10 C40,25 40,40 30,50 S20,75 30,90 M70,10 C60,25 60,40 70,50 S80,75 70,90" stroke="#8a2be2" stroke-width="6" fill="none"/><path d="M30 10 L70 10 M32 20 L68 20 M35 30 L65 30 M40 40 L60 40 M40 50 L60 50 M35 60 L65 60 M32 70 L68 70 M30 80 L70 80 M30 90 L70 90" stroke="#ff69b4" stroke-width="4" fill="none"/></svg> <svg id="vic-microscope" class="flair-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M40 90h20v5H40zM45 80h10v10H45z M30 75h40v5H30z M70 40a5 5 0 0 1-5 5h-5v20h10a5 5 0 0 1 5 5v5h-5v-5a10 10 0 0 0-10-10h-5V50h-5a10 10 0 0 0-10 10v5H20v-5a5 5 0 0 1 5-5h10V45h-5a5 5 0 0 1-5-5V20a5 5 0 0 1 5-5h5v-5h10v5h5a5 5 0 0 1 5 5z M50 25a15 15 0 1 1 0 30a15 15 0 0 1 0-30z" fill="#d4af37"/></svg> <svg id="vic-tube" class="flair-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M30 10h40v70a20 20 0 0 1-40 0z" fill="#90ee90" stroke="#32cd32" stroke-width="2"/><rect x="30" y="10" width="40" height="10" fill="#ffdb58" opacity="0.8"/></svg> <svg id="vic-virus" class="flair-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="25" fill="#ff7f50" /><path d="M50 25 L50 5 M50 75 L50 95 M75 50 L95 50 M25 50 L5 50 M68 32 L85 15 M32 68 L15 85 M32 32 L15 15 M68 68 L85 85" stroke="#dc143c" stroke-width="5" stroke-linecap="round" /></svg> </div> <h2>Victory!</h2> <p id="victory-message">Congratulations, <span id="winner-name">Player</span>! You correctly identified the morphology!</p> <p>You've earned a spot in the Hall of Fame!</p> <button id="viewHallOfFameButton">View Hall of Fame</button> <button class="playAgainButton secondary">Play Again</button> </div>

        <!-- Failure Screen -->
        <div id="failure-screen" class="screen"> <h2>Game Over</h2> <p id="failure-message">Oops! A mistake was made.</p> <p id="failure-morphology-info">Correct staining and identification are crucial! The correct morphology was: <strong id="correct-answer-display"></strong></p> <hr style="width: 80%; margin: 10px 0; border-color: #eee;"> <p class="flair-text">You receive a Goldie from Neelam!</p> <p class="flair-text">You get written up by Sharon!</p> <img id="incident-report-img" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='120' viewBox='0 0 160 120'%3E%3Crect width='156' height='116' x='2' y='2' fill='%23fff8dc' stroke='%23daa520' stroke-width='2' rx='5' ry='5'/%3E%3Ctext x='80' y='38' font-family='Impact, Charcoal, sans-serif' font-size='32' text-anchor='middle' fill='%23DAA520' stroke='%238B4513' stroke-width='0.5'%3EGOLDIE%3C/text%3E%3Ctext x='15' y='60' font-family='sans-serif' font-size='10' fill='%236b5a3f'%3EName of Offender:%3C/text%3E%3Cline x1='105' y1='59' x2='145' y2='59' stroke='%23d2b48c' stroke-width='1'/%3E%3Ctext x='15' y='78' font-family='sans-serif' font-size='10' fill='%236b5a3f'%3EIncident Details:%3C/text%3E%3Cline x1='95' y1='77' x2='145' y2='77' stroke='%23d2b48c' stroke-width='1'/%3E%3Cline x1='15' y1='87' x2='145' y2='87' stroke='%23d2b48c' stroke-width='1'/%3E%3Ctext x='80' y='108' font-family='monospace' font-size='9' text-anchor='middle' fill='%23b0a080'%3EMicro Dept - Lab Week Edition%3C/text%3E%3C/svg%3E" alt="Goldie Incident Report Form"> <hr style="width: 80%; margin: 10px 0; border-color: #eee;"> <button class="tryAgainButton">Try Again</button> <button id="failToHallOfFameButton" class="secondary">View Hall of Fame</button> <button id="failBackToStartButton" class="secondary">Back to Start</button> </div>

        <!-- Hall of Fame Screen -->
        <div id="hall-of-fame-screen" class="screen"> <h2>Hall of Fame</h2> <p>Our Microbiology Masters!</p> <ul id="hall-of-fame-list"> <li>Loading...</li> </ul> <button id="backToStartButton">Back to Start Screen</button> <button class="playAgainButton secondary">Play Again</button> <button id="clearHallOfFameButton" class="secondary">Clear Hall of Fame</button> </div>

    </div>

    <!-- Polyfill for mobile drag drop -->
    <script src="https://cdn.polyfill.io/v3/polyfill.min.js?features=Element.prototype.closest%2CCustomEvent"></script>
    <!-- Mobile Drag Drop Script -->
    <script src="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/dist/mobile-drag-drop.min.js"></script>
    <script>
        // Initialize the mobile drag drop polyfill
         // Call this after the page is loaded (hence inside DOMContentLoaded or after the script include)
         // It's generally safe to call it right away if included at the end.
        MobileDragDrop.polyfill({
             // Use this to force css dragged state
             forceApply: true,
              // Specifies what data transfer property to use for touch (default is 'move')
              // dragImageTranslateOverride: MobileDragDrop.scrollBehaviourDragImageTranslateOverride
        });
    </script>
    <!-- Main Game Script -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const screens = document.querySelectorAll('.screen');
            const startScreen = document.getElementById('start-screen');
            const shiftStartScreen = document.getElementById('shift-start-screen');
            const alertScreen = document.getElementById('alert-screen');
            const prepareSmearScreen = document.getElementById('prepare-smear-screen');
            const fixInstructionScreen = document.getElementById('fix-instruction-screen');
            const fixConfirmationScreen = document.getElementById('fix-confirmation-screen');
            const gamePhase1Screen = document.getElementById('game-phase-1');
            const gamePhase2Screen = document.getElementById('game-phase-2');
            const victoryScreen = document.getElementById('victory-screen');
            const failureScreen = document.getElementById('failure-screen');
            const hallOfFameScreen = document.getElementById('hall-of-fame-screen');
            const playerNameInput = document.getElementById('playerName');
            const startButton = document.getElementById('startButton');
            const startViewHallOfFameButton = document.getElementById('startViewHallOfFameButton');
            const prepWipeContainer = document.getElementById('prep-wipe-container');
            const prepNeedleContainer = document.getElementById('prep-needle-container');
            const prepBottleContainer = document.getElementById('prep-bottle-container');
            const prepItems = [prepWipeContainer, prepNeedleContainer, prepBottleContainer];
            const smearGraphicTarget = document.getElementById('smear-graphic-target');
            const smearSlideVisual = document.getElementById('smear-slide-visual');
            const smearSpot = smearSlideVisual?.querySelector('.smear-spot'); // Added safety check
            const prepFeedback = document.getElementById('prep-feedback');
            const fixSlideButton = document.getElementById('fixSlideButton');
            const goToStainButton = document.getElementById('goToStainButton');
            const reagentsContainer = document.getElementById('reagents');
            const slideDropzone = document.getElementById('slide-dropzone');
            const dropInstructionText = slideDropzone?.querySelector('.drop-instruction'); // Added safety check
            const stainStatus = document.getElementById('stain-status');
            const stainedArea = document.getElementById('stained-area');
            const microscopeImage = document.getElementById('microscope-image');
            const choicesContainer = document.getElementById('choices');
            const winnerNameSpan = document.getElementById('winner-name');
            const correctAnswerDisplay = document.getElementById('correct-answer-display');
            const failureMorphologyInfo = document.getElementById('failure-morphology-info');
            const viewHallOfFameButton = document.getElementById('viewHallOfFameButton');
            const hallOfFameList = document.getElementById('hall-of-fame-list');
            const backToStartButton = document.getElementById('backToStartButton');
            const failToHallOfFameButton = document.getElementById('failToHallOfFameButton');
            const failBackToStartButton = document.getElementById('failBackToStartButton');
            const clearHallOfFameButton = document.getElementById('clearHallOfFameButton');
            const playAgainButtons = document.querySelectorAll('.playAgainButton');
            const tryAgainButton = document.querySelector('.tryAgainButton');

            // --- Game State Variables ---
            let currentPlayerName = '';
            let hallOfFame = [];
            const CORRECT_PREP_ORDER = ['prep-wipe-container', 'prep-needle-container', 'prep-bottle-container'];
            let currentPrepStep = 0;
            let draggedPrepItemId = null;
            const CORRECT_STAIN_ORDER = ['reagent-cv', 'reagent-iodine', 'reagent-decolorizer', 'reagent-safranin'];
            const STAIN_COLORS = { 'reagent-cv': '#8a2be2', 'reagent-iodine': '#6a0dad', 'reagent-safranin': '#ff69b4' };
            let currentStainStep = 0;
            let draggedReagentId = null;
            const microscopeSamples = [ /* ... Your samples ... */
                 { id: 'staph', src: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Cdefs%3E%3CradialGradient id="grad1" cx="50%25" cy="50%25" r="50%25" fx="50%25" fy="50%25"%3E%3Cstop offset="0%25" style="stop-color:rgb(120,0,180);stop-opacity:1" /%3E%3Cstop offset="100%25" style="stop-color:rgb(80,0,120);stop-opacity:1" /%3E%3C/radialGradient%3E%3C/defs%3E%3Ccircle cx="50" cy="50" r="48" fill="%23f0f0f0"/%3E%3Ccircle cx="30" cy="30" r="5" fill="url(%23grad1)"/%3E%3Ccircle cx="35" cy="25" r="5" fill="url(%23grad1)"/%3E%3Ccircle cx="42" cy="30" r="5" fill="url(%23grad1)"/%3E%3Ccircle cx="38" cy="38" r="5" fill="url(%23grad1)"/%3E%3Ccircle cx="55" cy="55" r="5" fill="url(%23grad1)"/%3E%3Ccircle cx="60" cy="50" r="5" fill="url(%23grad1)"/%3E%3Ccircle cx="67" cy="55" r="5" fill="url(%23grad1)"/%3E%3Ccircle cx="63" cy="63" r="5" fill="url(%23grad1)"/%3E%3Ccircle cx="70" cy="70" r="5" fill="url(%23grad1)"/%3E%3Ccircle cx="75" cy="65" r="5" fill="url(%23grad1)"/%3E%3Ccircle cx="82" cy="70" r="5" fill="url(%23grad1)"/%3E%3Ccircle cx="78" cy="78" r="5" fill="url(%23grad1)"/%3E%3C/svg%3E', alt: 'Gram Positive Cocci in Clusters', correctAnswer: 'GPC Clusters', options: [ 'GPC Clusters', 'GPC Chains', 'GNR', 'GNC' ] },
                 { id: 'strep', src: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Cdefs%3E%3CradialGradient id="grad2" cx="50%25" cy="50%25" r="50%25" fx="50%25" fy="50%25"%3E%3Cstop offset="0%25" style="stop-color:rgb(120,0,180);stop-opacity:1" /%3E%3Cstop offset="100%25" style="stop-color:rgb(80,0,120);stop-opacity:1" /%3E%3C/radialGradient%3E%3C/defs%3E%3Ccircle cx="50" cy="50" r="48" fill="%23f0f0f0"/%3E%3Ccircle cx="20" cy="30" r="4" fill="url(%23grad2)"/%3E%3Ccircle cx="28" cy="32" r="4" fill="url(%23grad2)"/%3E%3Ccircle cx="36" cy="34" r="4" fill="url(%23grad2)"/%3E%3Ccircle cx="44" cy="36" r="4" fill="url(%23grad2)"/%3E%3Ccircle cx="52" cy="38" r="4" fill="url(%23grad2)"/%3E%3Ccircle cx="60" cy="60" r="4" fill="url(%23grad2)"/%3E%3Ccircle cx="68" cy="62" r="4" fill="url(%23grad2)"/%3E%3Ccircle cx="76" cy="64" r="4" fill="url(%23grad2)"/%3E%3Ccircle cx="84" cy="66" r="4" fill="url(%23grad2)"/%3E%3C/svg%3E', alt: 'Gram Positive Cocci in Chains', correctAnswer: 'GPC Chains', options: [ 'GPR', 'GPC Chains', 'GNC', 'GNR' ] },
                 { id: 'cperf', src: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Cdefs%3E%3ClinearGradient id="grad3" x1="0%25" y1="0%25" x2="100%25" y2="0%25"%3E%3Cstop offset="0%25" style="stop-color:rgb(120,0,180);stop-opacity:1" /%3E%3Cstop offset="100%25" style="stop-color:rgb(80,0,120);stop-opacity:1" /%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx="50" cy="50" r="48" fill="%23f0f0f0"/%3E%3Crect x="20" y="30" width="25" height="8" rx="4" ry="4" fill="url(%23grad3)" transform="rotate(-15 32.5 34)"/%3E%3Crect x="50" y="50" width="30" height="8" rx="4" ry="4" fill="url(%23grad3)" transform="rotate(10 65 54)"/%3E%3Crect x="60" y="70" width="28" height="8" rx="4" ry="4" fill="url(%23grad3)" transform="rotate(-5 74 74)"/%3E%3Crect x="30" y="65" width="26" height="8" rx="4" ry="4" fill="url(%23grad3)" transform="rotate(20 43 69)"/%3E%3C/svg%3E', alt: 'Gram Positive Rods', correctAnswer: 'GPR', options: [ 'GPR', 'GNR', 'GPC Clusters', 'GNC' ] },
                 { id: 'ecoli', src: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Cdefs%3E%3ClinearGradient id="grad4" x1="0%25" y1="0%25" x2="100%25" y2="0%25"%3E%3Cstop offset="0%25" style="stop-color:rgb(255,105,180);stop-opacity:1" /%3E%3Cstop offset="100%25" style="stop-color:rgb(220,20,60);stop-opacity:1" /%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx="50" cy="50" r="48" fill="%23f0f0f0"/%3E%3Crect x="25" y="35" width="20" height="6" rx="3" ry="3" fill="url(%23grad4)" transform="rotate(25 35 38)"/%3E%3Crect x="55" y="55" width="22" height="6" rx="3" ry="3" fill="url(%23grad4)" transform="rotate(-10 66 58)"/%3E%3Crect x="65" y="25" width="21" height="6" rx="3" ry="3" fill="url(%23grad4)" transform="rotate(5 75.5 28)"/%3E%3Crect x="35" y="70" width="19" height="6" rx="3" ry="3" fill="url(%23grad4)" transform="rotate(-30 44.5 73)"/%3E%3C/svg%3E', alt: 'Gram Negative Rods', correctAnswer: 'GNR', options: [ 'GPC Chains', 'GNR', 'GPR', 'GNC' ] },
                 { id: 'neisseria', src: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Cdefs%3E%3CradialGradient id="grad5" cx="50%25" cy="50%25" r="50%25" fx="50%25" fy="50%25"%3E%3Cstop offset="0%25" style="stop-color:rgb(255,105,180);stop-opacity:1" /%3E%3Cstop offset="100%25" style="stop-color:rgb(220,20,60);stop-opacity:1" /%3E%3C/radialGradient%3E%3C/defs%3E%3Ccircle cx="50" cy="50" r="48" fill="%23f0f0f0"/%3E%3Cpath d="M 30 40 A 5 5 0 0 1 40 40 A 5 5 0 0 1 30 40 Z" fill="url(%23grad5)" transform="translate(-2, 0)"/%3E%3Cpath d="M 40 40 A 5 5 0 0 1 50 40 A 5 5 0 0 1 40 40 Z" fill="url(%23grad5)" transform="translate(2, 0)"/%3E%3Cpath d="M 60 60 A 5 5 0 0 1 70 60 A 5 5 0 0 1 60 60 Z" fill="url(%23grad5)" transform="translate(-2, 0)"/%3E%3Cpath d="M 70 60 A 5 5 0 0 1 80 60 A 5 5 0 0 1 70 60 Z" fill="url(%23grad5)" transform="translate(2, 0)"/%3E%3Cpath d="M 45 75 A 5 5 0 0 1 55 75 A 5 5 0 0 1 45 75 Z" fill="url(%23grad5)" transform="translate(-2, 0)"/%3E%3Cpath d="M 55 75 A 5 5 0 0 1 65 75 A 5 5 0 0 1 55 75 Z" fill="url(%23grad5)" transform="translate(2, 0)"/%3E%3C/svg%3E', alt: 'Gram Negative Cocci (diplococci)', correctAnswer: 'GNC', options: [ 'GPC Clusters', 'GNR', 'GNC', 'GPR' ] }
            ];
            let currentSample = null;

            // --- Functions ---

            function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } }
            function randomizeReagents() { if (!reagentsContainer) return; const currentReagents = Array.from(reagentsContainer.querySelectorAll('.reagent')); shuffleArray(currentReagents); reagentsContainer.innerHTML = ''; currentReagents.forEach(reagent => reagentsContainer.appendChild(reagent)); }
            function showScreen(screenId) { screens.forEach(screen => screen.classList.toggle('active', screen.id === screenId)); }
            function showUserFeedback(element, message, type = 'success', duration = 2500) { if(!element) return; element.textContent = message; element.className = `${element.id} ${type}`; element.style.opacity = 1; void element.offsetWidth; setTimeout(() => { if (element.textContent === message) { element.style.opacity = 0; setTimeout(() => { if(element.style.opacity === '0') element.className = `${element.id}`; }, 500); } }, duration); }

            // --- Prep Phase Drag/Drop Handlers ---
             function handlePrepDragOver(event) {
                 event.preventDefault(); event.dataTransfer.dropEffect = 'move';
                 const expectedTargetId = (currentPrepStep < 2) ? 'prep-bottle-container' : 'smear-graphic-target';
                 const targetElement = document.getElementById(expectedTargetId);
                 if (event.target.closest('#' + expectedTargetId)) { if(targetElement && !targetElement.classList.contains('drag-over-target')) targetElement.classList.add('drag-over-target'); }
                 else { if(targetElement) targetElement.classList.remove('drag-over-target'); }
             }
             function handlePrepDragLeave(event) {
                  const potentialTarget = event.target.closest('#prep-bottle-container, #smear-graphic-target');
                  if(potentialTarget && !potentialTarget.contains(event.relatedTarget)) { potentialTarget.classList.remove('drag-over-target'); }
                  if (!event.relatedTarget) {
                       if(prepBottleContainer) prepBottleContainer.classList.remove('drag-over-target');
                       if(smearGraphicTarget) smearGraphicTarget.classList.remove('drag-over-target');
                    }
             }
            function handleSmearDrop(event) {
                 event.preventDefault(); if(prepBottleContainer) prepBottleContainer.classList.remove('drag-over-target'); if(smearGraphicTarget) smearGraphicTarget.classList.remove('drag-over-target');
                 const droppedItemId = event.dataTransfer.getData('text/plain'); const expectedItemId = CORRECT_PREP_ORDER[currentPrepStep]; const droppedElement = document.getElementById(droppedItemId); const originalDraggedPrepId = draggedPrepItemId; draggedPrepItemId = null;
                 if (!droppedElement || !originalDraggedPrepId || droppedItemId !== originalDraggedPrepId || droppedElement.classList.contains('used')) { console.warn("Prep Drop invalid."); const originalElem = document.getElementById(originalDraggedPrepId); if(originalElem && !originalElem.classList.contains('used')) originalElem.style.opacity = '1'; return; }
                 let actualTargetElement = event.target.closest('#prep-bottle-container, #smear-graphic-target'); let expectedTargetId = (currentPrepStep < 2) ? 'prep-bottle-container' : 'smear-graphic-target';
                 if (droppedItemId === expectedItemId && actualTargetElement && actualTargetElement.id === expectedTargetId) {
                     droppedElement.classList.add('used'); droppedElement.setAttribute('draggable', 'false'); droppedElement.style.opacity = '0.4'; currentPrepStep++;
                     let feedbackMsg = "", nextStepMsg = "";
                     if (currentPrepStep === 1) { feedbackMsg = "Bottle wiped!"; nextStepMsg = "Step 2: Drag Needle to Bottle."; }
                     else if (currentPrepStep === 2) { feedbackMsg = "Bottle tapped!"; nextStepMsg = "Step 3: Drag Bottle to Slide Area."; prepBottleContainer.classList.remove('used'); prepBottleContainer.setAttribute('draggable', 'true'); prepBottleContainer.style.opacity = '1'; smearGraphicTarget.classList.add('visible'); }
                     else if (currentPrepStep === 3) { feedbackMsg = "Smear applied!"; nextStepMsg = "Prep complete!"; if(smearSpot) smearSpot.classList.add('visible'); prepBottleContainer.classList.add('used'); prepBottleContainer.style.opacity = '0.4'; prepBottleContainer.setAttribute('draggable', 'false'); }
                     showUserFeedback(prepFeedback, feedbackMsg, 'success', 1500); setTimeout(() => { prepFeedback.textContent = nextStepMsg; prepFeedback.className = 'prep-feedback'; prepFeedback.style.opacity = 1; if (currentPrepStep === CORRECT_PREP_ORDER.length) { setTimeout(() => showScreen('fix-instruction-screen'), 1000); } }, 1600);
                 } else {
                     droppedElement.style.opacity = '1'; let errorMsg = "Try again!"; if (droppedItemId !== expectedItemId) { const expectedElem = document.getElementById(expectedItemId); errorMsg = `Wrong item! Drag the ${expectedElem?.querySelector('.prep-label')?.textContent || 'correct item'}.`; } else { const expectedTargetElem = document.getElementById(expectedTargetId); errorMsg = `Drop it onto the ${expectedTargetElem?.id === 'smear-graphic-target' ? 'Slide Area' : 'BC Bottle'}!`; }
                     showUserFeedback(prepFeedback, errorMsg, 'error');
                 }
             }

            // --- Staining Phase Drag/Drop Handlers ---
            function handleDragStart(event) {
                const item = event.target.closest('.prep-item, .reagent'); if (!item || item.classList.contains('used') || item.getAttribute('draggable') === 'false') { event.preventDefault(); return; }
                if (item.classList.contains('prep-item')) { draggedPrepItemId = item.id; event.dataTransfer.setData('text/plain', draggedPrepItemId); event.dataTransfer.effectAllowed = 'move'; setTimeout(() => item.style.opacity = '0.7', 0); }
                else if (item.classList.contains('reagent')) { draggedReagentId = item.id; event.dataTransfer.setData('text/plain', draggedReagentId); event.dataTransfer.effectAllowed = 'move'; setTimeout(() => item.style.opacity = '0.7', 0); }
            }
            function handleDragEnd(event) {
                 if(prepBottleContainer) prepBottleContainer.classList.remove('drag-over-target');
                 if(smearGraphicTarget) smearGraphicTarget.classList.remove('drag-over-target');
                 if(slideDropzone) slideDropzone.classList.remove('drag-over');
                 if (dropInstructionText) dropInstructionText.style.color = 'rgba(0, 0, 0, 0.5)';
                 const prepElem = document.getElementById(draggedPrepItemId); if (draggedPrepItemId && prepElem && !prepElem.classList.contains('used')) { prepElem.style.opacity = '1'; }
                 const reagentElem = document.getElementById(draggedReagentId); if (draggedReagentId && reagentElem && !reagentElem.classList.contains('used')) { reagentElem.style.opacity = '1'; }
                 draggedPrepItemId = null; draggedReagentId = null;
             }
            function handleStainDragOver(event) { event.preventDefault(); event.dataTransfer.dropEffect = 'move'; if(slideDropzone) slideDropzone.classList.add('drag-over'); if (dropInstructionText) dropInstructionText.style.color = 'rgba(0, 86, 179, 0.8)'; }
            function handleStainDragLeave(event) { if (slideDropzone && (event.target === slideDropzone || !slideDropzone.contains(event.relatedTarget))) { slideDropzone.classList.remove('drag-over'); if (dropInstructionText) dropInstructionText.style.color = 'rgba(0, 0, 0, 0.5)'; } }
            function handleStainDrop(event) {
                 event.preventDefault(); if(slideDropzone) slideDropzone.classList.remove('drag-over'); if (dropInstructionText) dropInstructionText.style.color = 'rgba(0, 0, 0, 0.5)';
                 const droppedReagentIdLocal = event.dataTransfer.getData('text/plain'); const expectedReagentId = CORRECT_STAIN_ORDER[currentStainStep]; const droppedElement = document.getElementById(droppedReagentIdLocal); const originallyDraggedId = draggedReagentId; draggedReagentId = null;
                 if (dropInstructionText) dropInstructionText.style.display = 'none'; if(slideDropzone) slideDropzone.classList.add('has-content');
                 if (!droppedElement || !originallyDraggedId || droppedElement.id !== originallyDraggedId || droppedElement.classList.contains('used')) { console.warn("Stain Drop issue."); const originalElem = document.getElementById(originallyDraggedId); if(originalElem && !originalElem.classList.contains('used')) originalElem.style.opacity = '1'; return; }

                 if (droppedReagentIdLocal === expectedReagentId) {
                     const reagentName = droppedElement.querySelector('.reagent-label').textContent; showUserFeedback(stainStatus, `${reagentName} applied correctly!`, 'success');
                     let colorToApply = STAIN_COLORS[expectedReagentId];
                     if (expectedReagentId === 'reagent-decolorizer') {
                         const retainedColor = STAIN_COLORS['reagent-iodine']; if(stainedArea){ stainedArea.style.transition = 'background-color 0.3s ease-out'; stainedArea.style.backgroundColor = 'rgba(106, 13, 173, 0.3)'; setTimeout(() => { stainedArea.style.transition = 'background-color 0.5s ease'; stainedArea.style.backgroundColor = retainedColor; }, 400); }
                         colorToApply = null;
                     } else if (colorToApply && stainedArea) {
                         stainedArea.style.transition = 'background-color 0.5s ease'; stainedArea.style.backgroundColor = colorToApply;
                     }
                     droppedElement.classList.add('used'); droppedElement.setAttribute('draggable', 'false'); droppedElement.style.opacity = '0.4'; currentStainStep++;
                     if (currentStainStep === CORRECT_STAIN_ORDER.length) { showUserFeedback(stainStatus,'Staining complete! Moving to microscope...', 'success'); setTimeout(transitionToPhase2, 1500); }
                 } else { console.log(`Incorrect stain drop: Expected ${expectedReagentId}, Got ${droppedReagentIdLocal}`); droppedElement.style.opacity = '1'; showFailure(false); }
             }

            // Reset Prep Phase visuals
            function resetPrepVisuals() {
                 prepItems.forEach(item => { if(item) { item.classList.remove('used'); item.setAttribute('draggable', 'true'); item.style.opacity = '1'; }});
                 if(prepBottleContainer) prepBottleContainer.setAttribute('draggable', 'true');
                 currentPrepStep = 0;
                 if(prepFeedback) { prepFeedback.textContent = 'Step 1: Drag Wipe to Bottle.'; prepFeedback.className = 'prep-feedback'; prepFeedback.style.opacity = 1; }
                 if(smearGraphicTarget) smearGraphicTarget.classList.remove('visible');
                 if(smearSpot) smearSpot.classList.remove('visible');
            }

            // Reset Stain Phase visuals
            function resetStainVisuals() {
                 if (reagentsContainer) { const allReagents = reagentsContainer.querySelectorAll('.reagent'); allReagents.forEach(reagent => { reagent.classList.remove('used'); reagent.setAttribute('draggable', 'true'); reagent.style.opacity = '1'; }); } else { console.warn("Reagents container not found during reset"); }
                 currentStainStep = 0; if (stainedArea) { stainedArea.style.backgroundColor = 'transparent'; } else { console.warn("Stained area not found during reset"); }
                 if (stainStatus) { stainStatus.textContent = 'Status'; stainStatus.className = 'stain-status'; stainStatus.style.opacity = 0; } else { console.warn("Stain status element not found during reset"); }
                 if (dropInstructionText) { dropInstructionText.style.display = 'block'; } else { console.warn("Drop instruction text not found during reset"); }
                 if (slideDropzone) { slideDropzone.classList.remove('has-content'); } else { console.warn("Slide dropzone not found during reset"); }
            }

            // --- Phase 2 Logic ---
            function transitionToPhase2() { setupPhase2(); showScreen('game-phase-2'); }
            function setupPhase2() { const sampleIndex = Math.floor(Math.random() * microscopeSamples.length); currentSample = microscopeSamples[sampleIndex]; microscopeImage.src = currentSample.src; microscopeImage.alt = currentSample.alt; choicesContainer.innerHTML = ''; const shuffledOptions = [...currentSample.options]; shuffleArray(shuffledOptions); shuffledOptions.forEach(optionText => { const button = document.createElement('button'); button.textContent = optionText; button.dataset.answer = optionText; button.addEventListener('click', handleAnswerSelection); choicesContainer.appendChild(button); }); }
            function handleAnswerSelection(event) { const selectedAnswer = event.target.dataset.answer; if (selectedAnswer === currentSample.correctAnswer) { showVictory(); } else { showFailure(true); } }

            // --- Screen Transitions & Actions ---
            function showVictory() { winnerNameSpan.textContent = currentPlayerName; addWinnerToHallOfFame(currentPlayerName); showScreen('victory-screen'); }
            function showFailure(isPhase2Fail = false) { if (failureMorphologyInfo && correctAnswerDisplay) { if (isPhase2Fail && currentSample) { correctAnswerDisplay.textContent = currentSample.correctAnswer; failureMorphologyInfo.style.display = 'block'; } else { failureMorphologyInfo.style.display = 'none'; } } else { console.error("Failure screen morphology elements not found!"); } showScreen('failure-screen'); }
            function showHallOfFameScreen() { displayHallOfFame(); showScreen('hall-of-fame-screen'); }

            // --- Hall of Fame Logic ---
            function loadHallOfFame() { const d=localStorage.getItem('microbiologyHallOfFame');try{hallOfFame=JSON.parse(d||'[]');if(!Array.isArray(hallOfFame))hallOfFame=[];}catch(e){hallOfFame=[];}}
            function saveHallOfFame() { try{localStorage.setItem('microbiologyHallOfFame',JSON.stringify(hallOfFame));}catch(e){console.error("HoF Save Error:",e);}}
            function addWinnerToHallOfFame(name) { const tName=name.trim();if(tName&&!hallOfFame.includes(tName)){hallOfFame.push(tName);saveHallOfFame();}}
            function displayHallOfFame() { hallOfFameList.innerHTML = ''; if(hallOfFame.length === 0){hallOfFameList.innerHTML='<li>No winners yet! Be the first!</li>';} else {[...hallOfFame].reverse().forEach(name=>{const li=document.createElement('li');li.textContent=name;hallOfFameList.appendChild(li);});}}
            function handleClearHoF() { if (confirm("Are you sure you want to clear the Hall of Fame? This cannot be undone.")) { hallOfFame = []; saveHallOfFame(); displayHallOfFame(); } }

            // --- Game Reset/Restart ---
            function resetGame(goToStartScreen = true) {
                 resetPrepVisuals(); resetStainVisuals();
                 if (goToStartScreen) { playerNameInput.value = ''; currentPlayerName = ''; showScreen('start-screen'); }
                 else { showScreen('shift-start-screen'); setTimeout(() => showScreen('alert-screen'), 1500); setTimeout(() => showScreen('prepare-smear-screen'), 4000); }
            }

            // --- Event Listeners Setup ---
             startButton.addEventListener('click', () => {
                 console.log("Start button clicked."); // Log 1
                 const name = playerNameInput.value.trim();
                 if (name) {
                     currentPlayerName = name;
                     console.log("Name valid, calling resets..."); // Log 2
                     try {
                          // Check core elements needed for reset/startup
                          if (!prepItems.every(el => el) || !prepFeedback || !smearGraphicTarget || !smearSpot) { console.error("One or more PREP elements missing before reset!"); alert("Game setup error (Prep). Please check console."); return; }
                          if (!reagentsContainer || !stainedArea || !stainStatus || !slideDropzone || !dropInstructionText) { console.error("One or more STAIN elements missing before reset!"); alert("Game setup error (Stain). Please check console."); return; }

                          resetPrepVisuals(); console.log("resetPrepVisuals completed.");
                          resetStainVisuals(); console.log("resetStainVisuals completed.");
                          console.log("Showing shift-start-screen..."); showScreen('shift-start-screen');
                          setTimeout(() => { console.log("Showing alert-screen"); showScreen('alert-screen'); }, 1500);
                          setTimeout(() => { console.log("Showing prepare-smear-screen"); showScreen('prepare-smear-screen'); }, 4000);
                     } catch (error) { console.error("Error during startup sequence:", error); alert("An error occurred starting the game. Please check the console (F12)."); }
                 } else { alert('Please enter your name!'); }
             });
            // Prep Phase Listeners
            prepItems.forEach(item => item.addEventListener('dragstart', handleDragStart));
            prepBottleContainer.addEventListener('dragover', handlePrepDragOver); prepBottleContainer.addEventListener('dragleave', handlePrepDragLeave); prepBottleContainer.addEventListener('drop', handleSmearDrop);
            smearGraphicTarget.addEventListener('dragover', handlePrepDragOver); smearGraphicTarget.addEventListener('dragleave', handlePrepDragLeave); smearGraphicTarget.addEventListener('drop', handleSmearDrop);
            // Stain Phase Listeners
            reagentsContainer.addEventListener('dragstart', handleDragStart);
            slideDropzone.addEventListener('dragover', handleStainDragOver); slideDropzone.addEventListener('dragleave', handleStainDragLeave); slideDropzone.addEventListener('drop', handleStainDrop);
            // Global Drag End
            document.addEventListener('dragend', handleDragEnd);
            // Button Listeners
            fixSlideButton.addEventListener('click', () => showScreen('fix-confirmation-screen'));
            goToStainButton.addEventListener('click', () => { randomizeReagents(); showScreen('game-phase-1'); });
            startViewHallOfFameButton.addEventListener('click', showHallOfFameScreen); clearHallOfFameButton.addEventListener('click', handleClearHoF); viewHallOfFameButton.addEventListener('click', showHallOfFameScreen); failToHallOfFameButton.addEventListener('click', showHallOfFameScreen); backToStartButton.addEventListener('click', () => resetGame(true)); failBackToStartButton.addEventListener('click', () => resetGame(true));
            playAgainButtons.forEach(button => button.addEventListener('click', () => resetGame(false))); tryAgainButton.addEventListener('click', () => resetGame(false));

            // --- Initial Setup ---
            loadHallOfFame(); showScreen('start-screen');
        });
    </script>

</body>
</html>
